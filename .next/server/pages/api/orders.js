"use strict";(()=>{var e={};e.id=722,e.ids=[722],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},470:e=>{e.exports=require("sql.js")},2048:e=>{e.exports=require("fs")},5315:e=>{e.exports=require("path")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},3875:(e,t,r)=>{r.r(t),r.d(t,{config:()=>p,default:()=>d,routeModule:()=>l});var s={};r.r(s),r.d(s,{default:()=>u});var i=r(1802),n=r(7153),o=r(6249),a=r(7837);async function u(e,t){let r=await (0,a.getDb)();if("GET"===e.method){let s=e.headers.authorization?.replace("Bearer ","");if(!s)return t.status(401).json({error:"Unauthorized"});let i=r.prepare(`SELECT * FROM sessions s JOIN users u ON s.user_id = u.id WHERE s.token = '${s}'`),n=null;if(i.step()&&(n=i.getAsObject()),i.free(),!n)return t.status(401).json({error:"Invalid session"});let o=[],a=r.prepare(`
      SELECT o.*, 
        (SELECT COUNT(*) FROM order_items WHERE order_id = o.id) as item_count
      FROM orders o 
      WHERE o.user_id = ${n.user_id}
      ORDER BY o.created_at DESC
    `);for(;a.step();)o.push(a.getAsObject());a.free(),t.status(200).json(o)}else if("POST"===e.method){let s=e.headers.authorization?.replace("Bearer ",""),{items:i,shippingAddress:n,shippingCity:o,shippingZip:u,shippingCountry:d}=e.body;if(!s)return t.status(401).json({error:"Unauthorized"});let p=r.prepare(`SELECT * FROM sessions WHERE token = '${s}'`),l=null;if(p.step()&&(l=p.getAsObject()),p.free(),!l)return t.status(401).json({error:"Invalid session"});let c=0;for(let e of i){let t=r.prepare(`SELECT * FROM products WHERE id = ${e.productId}`);t.step()&&(c+=t.getAsObject().price*e.quantity),t.free()}let f=`INSERT INTO orders (user_id, total, shipping_address, shipping_city, shipping_zip, shipping_country) VALUES (${l.user_id}, ${c}, '${n}', '${o}', '${u}', '${d}')`;try{r.run(f);let e=r.prepare("SELECT last_insert_rowid() as id");e.step();let s=e.getAsObject().id;for(let t of(e.free(),i)){let e=r.prepare(`SELECT * FROM products WHERE id = ${t.productId}`);if(e.step()){let i=e.getAsObject();r.run(`INSERT INTO order_items (order_id, product_id, quantity, price) VALUES (${s}, ${t.productId}, ${t.quantity}, ${i.price})`),r.run(`UPDATE products SET stock = stock - ${t.quantity} WHERE id = ${t.productId}`)}e.free()}(0,a.saveDb)(),t.status(201).json({orderId:s,total:c,message:"Order created successfully"})}catch(e){t.status(500).json({error:"Failed to create order"})}}else t.setHeader("Allow",["GET","POST"]),t.status(405).end(`Method ${e.method} Not Allowed`)}let d=(0,o.l)(s,"default"),p=(0,o.l)(s,"config"),l=new i.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/orders",pathname:"/api/orders",bundlePath:"",filename:""},userland:s})},7837:(e,t,r)=>{let s=r(470),i=r(2048),n=r(5315).join(process.cwd(),"database.db"),o=null,a=null;async function u(){if(o)return o;if(a||(a=await s()),i.existsSync(n)){let e=i.readFileSync(n);o=new a.Database(e)}else o=new a.Database;return o}function d(){if(o){let e=o.export(),t=Buffer.from(e);i.writeFileSync(n,t)}}e.exports={getDb:u,saveDb:d,prepare:function(e,t){return{run:(...r)=>(e.run(t,r),d(),{lastInsertRowid:e.exec("SELECT last_insert_rowid()")[0]?.values[0][0]}),get:(...r)=>{let s=e.prepare(t);if(s.bind(r),s.step()){let e=s.getAsObject();return s.free(),e}s.free()},all:(...r)=>{let s=[],i=e.prepare(t);for(i.bind(r);i.step();)s.push(i.getAsObject());return i.free(),s}}}}},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=3875);module.exports=r})();